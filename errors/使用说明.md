# é”™è¯¯å¤„ç†ç³»ç»Ÿä½¿ç”¨è¯´æ˜

## æ¦‚è¿°

errorsæ¨¡å—æ˜¯ä¸€ä¸ªé€šç”¨ã€çµæ´»çš„é”™è¯¯å¤„ç†ç³»ç»Ÿï¼Œä¸“ä¸ºGoè¯­è¨€è®¾è®¡ã€‚å®ƒæä¾›äº†å®Œæ•´çš„é”™è¯¯åˆ›å»ºã€åŒ…è£…ã€åˆ†ç±»ã€å¤„ç†å’Œæ ¼å¼åŒ–åŠŸèƒ½ï¼Œé€‚ç”¨äºå„ç§ä¸šåŠ¡åœºæ™¯ã€‚

## æ ¸å¿ƒç‰¹æ€§

- ğŸ¯ **é€šç”¨æ€§**: ä¸å†å±€é™äºç‰¹å®šä¸šåŠ¡åœºæ™¯
- ğŸ”§ **å¯æ‰©å±•**: æ”¯æŒåŠ¨æ€é”™è¯¯ç æ³¨å†Œå’Œç®¡ç†
- ğŸ“Š **åˆ†ç±»ç³»ç»Ÿ**: è‡ªåŠ¨é”™è¯¯åˆ†ç±»ï¼ˆç³»ç»Ÿã€å®¢æˆ·ç«¯ã€ä¸šåŠ¡ï¼‰
- ğŸ—ï¸ **æ„å»ºå™¨æ¨¡å¼**: é“¾å¼è°ƒç”¨åˆ›å»ºå¤æ‚é”™è¯¯
- ğŸ¨ **æ ¼å¼åŒ–å™¨**: å¤šç§é”™è¯¯è¾“å‡ºæ ¼å¼
- âš¡ **é«˜æ€§èƒ½**: çº¿ç¨‹å®‰å…¨ï¼Œæ”¯æŒé«˜å¹¶å‘
- ğŸ“š **å®Œæ•´API**: ä¸°å¯Œçš„é”™è¯¯å¤„ç†å·¥å…·å‡½æ•°

## å¿«é€Ÿå¼€å§‹

### åŸºç¡€é”™è¯¯åˆ›å»º

```go
import "github.com/iwen-conf/utils-pkg/errors"

// åˆ›å»ºç®€å•é”™è¯¯
err := errors.New("USER001", "ç”¨æˆ·ä¸å­˜åœ¨")

// åˆ›å»ºå¸¦è¯¦ç»†ä¿¡æ¯çš„é”™è¯¯
err = errors.NewWithDetails("DATA001", "æ•°æ®éªŒè¯å¤±è´¥", "è¾“å…¥å‚æ•°ä¸ç¬¦åˆè¦æ±‚")

// åŒ…è£…ç°æœ‰é”™è¯¯
dbErr := fmt.Errorf("æ•°æ®åº“è¿æ¥å¤±è´¥")
err = errors.Wrap(dbErr, "DB001", "æ•°æ®åº“æ“ä½œå¼‚å¸¸")
```

### é”™è¯¯ç æ³¨å†Œ

```go
// æ³¨å†Œå•ä¸ªé”™è¯¯ç 
errors.RegisterErrorCode("CUSTOM001", "è‡ªå®šä¹‰ä¸šåŠ¡é”™è¯¯")

// æ‰¹é‡æ³¨å†Œé”™è¯¯ç 
errors.RegisterErrorCodes(map[string]string{
    "AUTH001": "è®¤è¯å¤±è´¥",
    "AUTH002": "æƒé™ä¸è¶³",
    "AUTH003": "ä»¤ç‰Œè¿‡æœŸ",
})

// æ³¨å†Œé”™è¯¯ç å‰ç¼€åˆ†ç±»
errors.RegisterErrorPrefix("AUTH", "authentication")
errors.RegisterErrorPrefix("USER", "user_management")
```

## è¯¦ç»†åŠŸèƒ½

### 1. é”™è¯¯ç»“æ„ä½“

```go
type Error struct {
    Code       string                 // é”™è¯¯ç 
    Message    string                 // é”™è¯¯æ¶ˆæ¯
    Details    string                 // è¯¦ç»†é”™è¯¯ä¿¡æ¯
    Timestamp  time.Time              // é”™è¯¯å‘ç”Ÿæ—¶é—´
    Context    map[string]interface{} // ä¸Šä¸‹æ–‡ä¿¡æ¯
    Original   error                  // åŸå§‹é”™è¯¯
    StackTrace []StackFrame           // å †æ ˆè·Ÿè¸ª
}
```

### 2. é”™è¯¯æ„å»ºå™¨

ä½¿ç”¨æ„å»ºå™¨æ¨¡å¼åˆ›å»ºå¤æ‚çš„é”™è¯¯ï¼š

```go
err := errors.NewBuilder().
    Code("USER001").
    Message("ç”¨æˆ·ä¸å­˜åœ¨").
    Details("ç”¨æˆ·IDæ— æ•ˆ").
    Context("user_id", "user123").
    Context("request_id", "req_456").
    Context("timestamp", time.Now().Unix()).
    Build()
```

### 3. é”™è¯¯åˆ†ç±»ç³»ç»Ÿ

ç³»ç»Ÿè‡ªåŠ¨æ ¹æ®é”™è¯¯ç å‰ç¼€è¿›è¡Œåˆ†ç±»ï¼š

```go
// æ ¹æ®é”™è¯¯ç åˆ¤æ–­ç±»å‹
if errors.IsSystemError("5000") {
    // ç³»ç»Ÿçº§é”™è¯¯
}

if errors.IsClientError("4001") {
    // å®¢æˆ·ç«¯é”™è¯¯
}

if errors.IsBusinessErrorCode("6001") {
    // ä¸šåŠ¡é”™è¯¯
}

// è·å–é”™è¯¯åˆ†ç±»
category := errors.GetCategoryByCode("5000") // è¿”å› "server"
```

### 4. é”™è¯¯æ ¼å¼åŒ–å™¨

æ”¯æŒå¤šç§é”™è¯¯è¾“å‡ºæ ¼å¼ï¼š

```go
// é»˜è®¤æ ¼å¼åŒ–å™¨
formatted := errors.FormatError(err)
// è¾“å‡º: Code: USER001 | Message: ç”¨æˆ·ä¸å­˜åœ¨ | Details: ç”¨æˆ·IDæ— æ•ˆ

// JSONæ ¼å¼åŒ–å™¨
errors.SetDefaultFormatter(&errors.JSONFormatter{})
formatted = errors.FormatError(err)
// è¾“å‡º: {"code":"USER001","message":"ç”¨æˆ·ä¸å­˜åœ¨","details":"ç”¨æˆ·IDæ— æ•ˆ"}

// è‡ªå®šä¹‰æ ¼å¼åŒ–å™¨
type CustomFormatter struct{}

func (f *CustomFormatter) Format(err *errors.Error) string {
    return fmt.Sprintf("[%s] %s", err.Code, err.Message)
}

errors.SetDefaultFormatter(&CustomFormatter{})
```

### 5. é”™è¯¯å¤„ç†å™¨é“¾

æ”¯æŒé“¾å¼é”™è¯¯å¤„ç†ï¼š

```go
handlerChain := errors.NewHandlerChain().
    Add(func(err *errors.Error) error {
        // è®°å½•é”™è¯¯æ—¥å¿—
        log.Printf("Error: %s", err.Error())
        return nil
    }).
    Add(func(err *errors.Error) error {
        // å‘é€é”™è¯¯é€šçŸ¥
        if errors.IsSystemError(err.Code) {
            sendAlert(err)
        }
        return nil
    }).
    Add(func(err *errors.Error) error {
        // é”™è¯¯ç»Ÿè®¡
        incrementErrorCounter(err.Code)
        return nil
    })

// å¤„ç†é”™è¯¯
handlerChain.Handle(err)
```

### 6. é”™è¯¯èšåˆå™¨

æ”¶é›†å’Œå¤„ç†å¤šä¸ªé”™è¯¯ï¼š

```go
aggregator := errors.NewAggregator()

// æ”¶é›†å¤šä¸ªé”™è¯¯
aggregator.Add(err1)
aggregator.Add(err2)
aggregator.Add(err3)

if aggregator.HasErrors() {
    // å¤„ç†èšåˆçš„é”™è¯¯
    for _, err := range aggregator.Errors() {
        fmt.Printf("Error: %s\n", err.Error())
    }
    
    // è·å–èšåˆé”™è¯¯çš„å­—ç¬¦ä¸²è¡¨ç¤º
    fmt.Println(aggregator.Error())
}

// æ¸…ç©ºèšåˆå™¨
aggregator.Clear()
```

### 7. é”™è¯¯åˆ¤æ–­å·¥å…·

```go
// æ£€æŸ¥æ˜¯å¦ä¸ºä¸šåŠ¡é”™è¯¯
if errors.IsBusinessError(err) {
    // å¤„ç†ä¸šåŠ¡é”™è¯¯
}

// è·å–ä¸šåŠ¡é”™è¯¯
if businessErr := errors.GetBusinessError(err); businessErr != nil {
    // ä½¿ç”¨ä¸šåŠ¡é”™è¯¯
}

// æ£€æŸ¥é”™è¯¯ç 
if errors.HasCode(err, "USER001") {
    // å¤„ç†ç‰¹å®šé”™è¯¯ç 
}

// è·å–é”™è¯¯ä¿¡æ¯
code := errors.GetErrorCode(err)
message := errors.GetErrorMessage(err)
details := errors.GetErrorDetails(err)
context := errors.GetErrorContext(err)
```

### 8. å †æ ˆè·Ÿè¸ª

```go
// å…¨å±€å¼€å¯å †æ ˆè·Ÿè¸ª
errors.SetEnableStackTrace(true)

// åˆ›å»ºå¸¦å †æ ˆè·Ÿè¸ªçš„é”™è¯¯
err := errors.NewWithStack("ERROR001", "å‘ç”Ÿé”™è¯¯")

// åŒ…è£…é”™è¯¯æ—¶æ·»åŠ å †æ ˆè·Ÿè¸ª
err = errors.WrapWithStack(originalErr, "ERROR002", "åŒ…è£…é”™è¯¯")
```

## é¢„å®šä¹‰é”™è¯¯ç 

ç³»ç»Ÿæä¾›äº†ä¸€å¥—é€šç”¨çš„é”™è¯¯ç ä½“ç³»ï¼š

### å®¢æˆ·ç«¯é”™è¯¯ (4xxx)
- `4000`: è¯·æ±‚é”™è¯¯
- `4001`: æœªæˆæƒ
- `4003`: ç¦æ­¢è®¿é—®
- `4004`: èµ„æºä¸å­˜åœ¨
- `4005`: æ–¹æ³•ä¸å…è®¸
- `4008`: è¯·æ±‚è¶…æ—¶
- `4009`: èµ„æºå†²çª
- `4029`: è¯·æ±‚è¿‡äºé¢‘ç¹

### æœåŠ¡ç«¯é”™è¯¯ (5xxx)
- `5000`: å†…éƒ¨æœåŠ¡å™¨é”™è¯¯
- `5001`: åŠŸèƒ½æœªå®ç°
- `5002`: ç½‘å…³é”™è¯¯
- `5003`: æœåŠ¡ä¸å¯ç”¨
- `5004`: ç½‘å…³è¶…æ—¶

### ä¸šåŠ¡é”™è¯¯ (6xxx)
- `6000`: ä¸šåŠ¡é”™è¯¯
- `6001`: æ•°æ®éªŒè¯é”™è¯¯
- `6002`: æ•°æ®ä¸å­˜åœ¨
- `6003`: æ•°æ®å·²å­˜åœ¨
- `6004`: æ“ä½œå¤±è´¥

## æœ€ä½³å®è·µ

### 1. é”™è¯¯ç å‘½åè§„èŒƒ

```go
// æ¨èï¼šä½¿ç”¨æœ‰æ„ä¹‰çš„é”™è¯¯ç 
errors.RegisterErrorCode("USER_NOT_FOUND", "ç”¨æˆ·ä¸å­˜åœ¨")
errors.RegisterErrorCode("INVALID_PASSWORD", "å¯†ç æ— æ•ˆ")

// ä¸æ¨èï¼šä½¿ç”¨æ— æ„ä¹‰çš„æ•°å­—
errors.RegisterErrorCode("1001", "ç”¨æˆ·ä¸å­˜åœ¨")
```

### 2. é”™è¯¯ä¸Šä¸‹æ–‡ä¿¡æ¯

```go
err := errors.NewBuilder().
    Code("USER001").
    Message("ç”¨æˆ·ä¸å­˜åœ¨").
    Context("user_id", userID).
    Context("request_id", requestID).
    Context("timestamp", time.Now().Unix()).
    Build()
```

### 3. é”™è¯¯å¤„ç†ç­–ç•¥

```go
// æ ¹æ®é”™è¯¯ç±»å‹é‡‡ç”¨ä¸åŒç­–ç•¥
switch errors.GetCategoryByCode(err.Code) {
case "client":
    // å®¢æˆ·ç«¯é”™è¯¯ï¼Œè¿”å›ç»™ç”¨æˆ·
    return http.StatusBadRequest, err
case "server":
    // æœåŠ¡ç«¯é”™è¯¯ï¼Œè®°å½•æ—¥å¿—å¹¶è¿”å›é€šç”¨é”™è¯¯
    log.Printf("Server error: %v", err)
    return http.StatusInternalServerError, errors.New("5000", "å†…éƒ¨æœåŠ¡å™¨é”™è¯¯")
case "business":
    // ä¸šåŠ¡é”™è¯¯ï¼Œè¿”å›å…·ä½“é”™è¯¯ä¿¡æ¯
    return http.StatusUnprocessableEntity, err
default:
    // æœªçŸ¥é”™è¯¯ï¼Œè®°å½•æ—¥å¿—
    log.Printf("Unknown error: %v", err)
    return http.StatusInternalServerError, errors.New("5000", "å†…éƒ¨æœåŠ¡å™¨é”™è¯¯")
}
```

### 4. é”™è¯¯èšåˆå¤„ç†

```go
// åœ¨æ‰¹é‡æ“ä½œä¸­æ”¶é›†é”™è¯¯
aggregator := errors.NewAggregator()

for _, item := range items {
    if err := processItem(item); err != nil {
        aggregator.Add(err)
    }
}

if aggregator.HasErrors() {
    // å¤„ç†æ‰€æœ‰é”™è¯¯
    log.Printf("Batch operation failed with %d errors", len(aggregator.Errors()))
    return aggregator.Error()
}
```

## æ€§èƒ½è€ƒè™‘

- é”™è¯¯ç æ³¨å†Œä½¿ç”¨è¯»å†™é”ï¼Œæ”¯æŒé«˜å¹¶å‘
- é”™è¯¯æ„å»ºå™¨å¤ç”¨å†…å­˜ï¼Œå‡å°‘GCå‹åŠ›
- æ ¼å¼åŒ–å™¨æ”¯æŒç¼“å­˜ï¼Œæé«˜é‡å¤æ ¼å¼åŒ–æ€§èƒ½
- å †æ ˆè·Ÿè¸ªå¯é€‰å¼€å¯ï¼Œé¿å…æ€§èƒ½å¼€é”€

## æµ‹è¯•

æ¨¡å—åŒ…å«å®Œæ•´çš„æµ‹è¯•è¦†ç›–ï¼š

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
go test ./...

# è¿è¡ŒåŸºå‡†æµ‹è¯•
go test -bench=. ./...

# è¿è¡Œæµ‹è¯•å¹¶æ˜¾ç¤ºè¦†ç›–ç‡
go test -cover ./...
```

## æ€»ç»“

errorsæ¨¡å—æä¾›äº†ä¸€ä¸ªå®Œæ•´ã€çµæ´»ã€é«˜æ€§èƒ½çš„é”™è¯¯å¤„ç†è§£å†³æ–¹æ¡ˆã€‚å®ƒä¸å†å±€é™äºç‰¹å®šä¸šåŠ¡åœºæ™¯ï¼Œå¯ä»¥é€‚ç”¨äºå„ç§Goé¡¹ç›®ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºå¥å£®çš„é”™è¯¯å¤„ç†ç³»ç»Ÿã€‚
